#!/usr/bin/env bash
# TheHackerWire CVE Tracker RSS ê°ì‹œ â†’ Discord Embed ì¹´ë“œë¡œ ì•Œë¦¼

CVE_FEED="https://www.thehackerwire.com/cve-tracker/feed/"
CACHE_FILE="$HOME/.$(echo "$DISCORD_URL" | sed 's/https:\/\/discord.com\/api\/webhooks\///' | awk -F '/' '{ print $1 }')"
DISCORD_URL="${DISCORD_URL:-}"
CVE_KEYWORDS="${CVE_KEYWORDS:-}"
DEEPL_API_KEY="${DEEPL_API_KEY:-}"
DEEPL_TARGET_LANG="${DEEPL_TARGET_LANG:-KO}"  # ê¸°ë³¸ê°’: KO (í•œêµ­ì–´)

if [ -z "$DISCORD_URL" ]; then
    echo 'Please set DISCORD_URL to use this script.' >&2
    exit 1
fi

# ìºì‹œ íŒŒì¼ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
[ ! -f "$CACHE_FILE" ] && touch "$CACHE_FILE"

# DeepL APIë¥¼ ì‚¬ìš©í•œ ë²ˆì—­ í•¨ìˆ˜
translate_text() {
    local text="$1"

    # DEEPL_API_KEYê°€ ì—†ìœ¼ë©´ ì›ë¬¸ ë°˜í™˜
    if [ -z "$DEEPL_API_KEY" ]; then
        echo "$text"
        return
    fi

    # API í‚¤ê°€ :fxë¡œ ëë‚˜ë©´ Free API, ì•„ë‹ˆë©´ Pro API
    if [[ "$DEEPL_API_KEY" =~ :fx$ ]]; then
        DEEPL_API_URL="https://api-free.deepl.com/v2/translate"
    else
        DEEPL_API_URL="https://api.deepl.com/v2/translate"
    fi

    # DeepL API í˜¸ì¶œ
    local translated
    translated=$(curl -s -X POST "$DEEPL_API_URL" \
        -H "Authorization: DeepL-Auth-Key $DEEPL_API_KEY" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "text=$text" \
        -d "target_lang=$DEEPL_TARGET_LANG" \
        | jq -r '.translations[0].text // empty' 2>/dev/null)

    # ë²ˆì—­ ì‹¤íŒ¨ ì‹œ ì›ë¬¸ ë°˜í™˜
    if [ -z "$translated" ]; then
        echo "$text"
    else
        echo "$translated"
    fi

    # API rate limit ë°©ì§€ë¥¼ ìœ„í•œ ì§€ì—°
    sleep 0.2
}

# RSS í”¼ë“œ ë‹¤ìš´ë¡œë“œ í›„ ì¤„ë°”ê¿ˆ ì œê±°í•˜ì—¬ íŒŒì‹±
curl -s "$CVE_FEED" \
    | tr '\n' ' ' \
    | sed 's/<item>/\n<item>/g' \
    | grep '<item>' \
    | while read -r line; do

    # ê° í•„ë“œ ì¶”ì¶œ
    title=$(echo "$line" | grep -oP '<title>\K[^<]+' | tr -d '\n' | sed 's/  */ /g' | xargs)
    link=$(echo "$line" | grep -oP '<link>\K[^<]+')
    pubDate=$(echo "$line" | grep -oP '<pubDate>\K[^<]+')
    desc=$(echo "$line" | grep -oP '<description><!\[CDATA\[\K[^\]]+' | head -c 500)

    # CVE ID ì¶”ì¶œ (ìºì‹œ í‚¤ë¡œ ì‚¬ìš©)
    CVE_ID=$(echo "$title" | grep -oP 'CVE-\d{4}-\d+')

    # CVE IDê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
    if [ -z "$CVE_ID" ]; then
        continue
    fi

    # ì´ë¯¸ ìºì‹œì— ìˆìœ¼ë©´ ìŠ¤í‚µ
    if grep -qFx "$CVE_ID" "$CACHE_FILE"; then
        continue
    fi

    echo "ğŸ†• New CVE Alert: $title"

    # ì‹¬ê°ë„ ì¶”ì¶œ
    SEVERITY=$(echo "$title" | grep -oP '(Critical|High|Medium|Low|Info)' | head -n1)
    CVSS_SCORE=$(echo "$title" | grep -oP 'CVSS \d+\.\d+' | grep -oP '\d+\.\d+')

    # Medium ì´í•˜ëŠ” ë¬´ì‹œ (Critical, Highë§Œ ì²˜ë¦¬)
    if [[ "$SEVERITY" != "Critical" && "$SEVERITY" != "High" ]]; then
        echo "â­ï¸  Skipped (Low severity): $title"
        echo "$CVE_ID" >> "$CACHE_FILE"
        continue
    fi

    # í‚¤ì›Œë“œ í•„í„°ë§ (CVE_KEYWORDS í™˜ê²½ ë³€ìˆ˜)
    if [ -n "$CVE_KEYWORDS" ]; then
        MATCHED=false
        for keyword in $(echo "$CVE_KEYWORDS" | tr ',' ' '); do
            if echo "$title $desc" | grep -qi "$keyword"; then
                MATCHED=true
                break
            fi
        done

        if [ "$MATCHED" = false ]; then
            echo "â­ï¸  Skipped (No keyword match): $title"
            echo "$CVE_ID" >> "$CACHE_FILE"
            continue
        fi
    fi

    # ì‹¬ê°ë„ì— ë”°ë¥¸ ìƒ‰ìƒ ë° ì´ëª¨ì§€ ì„¤ì •
    case "$SEVERITY" in
        Critical)
            COLOR=15158332  # ë¹¨ê°•
            EMOJI="ğŸ›‘"
            ;;
        High)
            COLOR=16753920  # ì£¼í™©
            EMOJI="âš ï¸"
            ;;
    esac

    # description ì •ë¦¬ (HTML íƒœê·¸ ì œê±°)
    CLEAN_DESC=$(echo "$desc" | sed 's/<[^>]*>//g' | sed 's/&nbsp;/ /g' | sed 's/&amp;/\&/g' | sed 's/&lt;/</g' | sed 's/&gt;/>/g' | xargs)
    [ ${#CLEAN_DESC} -gt 500 ] && CLEAN_DESC="${CLEAN_DESC:0:500}..."

    # DeepL APIë¡œ ë²ˆì—­
    CLEAN_DESC=$(translate_text "$CLEAN_DESC")

    # Discord Embed JSON ìƒì„±
    JSON_PAYLOAD=$(jq -n \
        --arg title "$EMOJI New CVE Alert: $CVE_ID" \
        --arg severity "$SEVERITY" \
        --arg cvss "$CVSS_SCORE" \
        --arg link "$link" \
        --arg desc "$CLEAN_DESC" \
        --arg pubDate "$pubDate" \
        --argjson color "$COLOR" \
        '{
          "embeds": [{
            "title": $title,
            "url": $link,
            "color": $color,
            "fields": [
              {"name": "ğŸ”´ Severity", "value": $severity, "inline": true},
              {"name": "ğŸ“Š CVSS Score", "value": $cvss, "inline": true},
              {"name": "ğŸ“ Description", "value": $desc, "inline": false}
            ],
            "footer": {"text": "TheHackerWire CVE Tracker"},
            "timestamp": ($pubDate | strptime("%a, %d %b %Y %H:%M:%S %z") | strftime("%Y-%m-%dT%H:%M:%SZ"))
          }]
        }'
    )

    # ì „ì†¡
    curl -s -H "Content-Type: application/json" \
         -X POST \
         -d "$JSON_PAYLOAD" \
         "$DISCORD_URL" >/dev/null

    # ìºì‹œì— ê¸°ë¡
    echo "$CVE_ID" >> "$CACHE_FILE"
done
