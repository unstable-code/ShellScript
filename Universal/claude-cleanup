#!/bin/bash

CLAUDE_DIR="$HOME/.claude"
PROJECTS_DIR="${CLAUDE_DIR}/projects"

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

if [ ! -d "$PROJECTS_DIR" ]; then
    echo -e "${RED}ì—ëŸ¬: $PROJECTS_DIR í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.${NC}"
    exit 1
fi

# ì§€ëŠ¥í˜• ê²½ë¡œ ë³µêµ¬ í•¨ìˆ˜ (ê²€ì¦ ë¡œì§ ê°•í™”)
smart_restore() {
    local folder=$1
    local raw=$(echo "$folder" | sed 's/--/\/\./g' | sed 's/^-//')
    IFS='-' read -ra PARTS <<< "$raw"
    local current="/"
    local i=0
    while [ $i -lt ${#PARTS[@]} ]; do
        local found=false
        for (( j=${#PARTS[@]}-1; j>=i; j-- )); do
            local segment=""
            for (( k=i; k<=j; k++ )); do
                if [ -z "$segment" ]; then segment="${PARTS[$k]}"; else segment="${segment}-${PARTS[$k]}"; fi
            done
            if [ -d "$current/$segment" ]; then
                current="${current%/}/$segment"; i=$((j + 1)); found=true; break
            elif [ -d "$current/.$segment" ]; then
                current="${current%/}/.$segment"; i=$((j + 1)); found=true; break
            fi
        done
        if [ "$found" = false ]; then
            local p="${PARTS[$i]}"
            if [ "$current" == "/" ]; then current="/$p"; else current="${current}-$p"; fi
            i=$((i + 1))
        fi
    done
    echo "$current" | sed 's/\/\//\//g'
}

while true; do
    echo -e "\n--- ${BLUE}Claude Code ì„¸ì…˜ ëª©ë¡ (í™œë™ ìˆœ)${NC} ---"

    mapfile -t real_folders < <(ls -1t "$PROJECTS_DIR" 2>/dev/null)
    
    if [ ${#real_folders[@]} -eq 0 ]; then
        echo -e "${YELLOW}ê´€ë¦¬í•  ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.${NC}"
        break
    fi

    display_options=()
    for f in "${real_folders[@]}"; do
        restored=$(smart_restore "$f")
        access_time=$(ls -ld --time-style="+%Y-%m-%d %H:%M" "$PROJECTS_DIR/$f" | awk '{print $6, $7}')
        
        # [ìˆ˜ì •] ì¶œë ¥ í˜•ì‹ ì •ë ¬ (MISSING ìœ ë¬´ì— ë”°ë¥¸ ê³µë°± ì²˜ë¦¬)
        if [ -d "$restored" ]; then
            # MISSING ìë¦¬ì— 10ì¹¸ì˜ ê³µë°±ì„ ì±„ì›Œ ì •ë ¬ ìœ ì§€
            display_options+=("[$access_time]           $restored")
        else
            display_options+=("[$access_time] [MISSING] $restored")
        fi
    done

    PS3=$'\në²ˆí˜¸ ì„ íƒ (ì¢…ë£Œ: q): '
    select opt in "${display_options[@]}"; do
        if [[ $REPLY == "q" ]]; then exit 0; fi
        if [ -n "$opt" ]; then
            idx=$((REPLY-1))
            real_name="${real_folders[$idx]}"
            
            # íƒœê·¸ì™€ ë‚ ì§œ ì œê±° í›„ ìˆœìˆ˜ ê²½ë¡œë§Œ ì¶”ì¶œ
            clean_path=$(echo "$opt" | sed -E 's/^\[.*\] (\[MISSING\] )?//' | sed 's/^ *//')
            
            echo -e "\n${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
            if [[ "$opt" == *"[MISSING]"* ]]; then
                echo -e "ğŸ“ ë³µì› ê²½ë¡œ: ${RED}$clean_path (ë””ë ‰í† ë¦¬ ì—†ìŒ)${NC}"
            else
                echo -e "ğŸ“ ë³µì› ê²½ë¡œ: ${GREEN}$clean_path${NC}"
            fi
            echo -e "ğŸ•’ ë§ˆì§€ë§‰ í™œë™: $(echo "$opt" | awk -F'[][]' '{print $2}')"
            echo -e "ğŸ“ ì‹¤ì œ í´ë”ëª…: ${YELLOW}$real_name${NC}"
            echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
            
            echo -en "${RED}ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N)${NC} > "
            read -r confirm
            if [[ $confirm == [yY] ]]; then
                rm -rf "${PROJECTS_DIR}/${real_name}"
                [ -f "${CLAUDE_DIR}/history.jsonl" ] && grep -v "$real_name" "${CLAUDE_DIR}/history.jsonl" > "${CLAUDE_DIR}/history.jsonl.tmp" && mv "${CLAUDE_DIR}/history.jsonl.tmp" "${CLAUDE_DIR}/history.jsonl"
                find "${CLAUDE_DIR}/session-env" "${CLAUDE_DIR}/tasks" -name "*${real_name}*" -exec rm -rf {} + 2>/dev/null
                echo -e "${GREEN}âœ… ì‚­ì œ ì™„ë£Œ!${NC}"
            fi
            break 
        else
            echo -e "${YELLOW}ì˜ëª»ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.${NC}"
            break
        fi
    done
done
