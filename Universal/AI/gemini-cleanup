#!/bin/bash

GEMINI_DIR="$HOME/.gemini"
TMP_DIR="${GEMINI_DIR}/tmp"

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

if [ ! -d "$TMP_DIR" ]; then
    echo -e "${RED}ì—ëŸ¬: $TMP_DIR í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.${NC}"
    exit 1
fi

while true; do
    echo -e "\n--- ${BLUE}Gemini CLI ì„¸ì…˜ ëª©ë¡ (í™œë™ ìˆœ)${NC} ---"

    # 1. í™œë™ ì‹œê°„ìˆœìœ¼ë¡œ í•´ì‹œ í´ë” ëª©ë¡ ìƒì„±
    mapfile -t folders < <(ls -1t "$TMP_DIR" | grep -v "bin")

    if [ ${#folders[@]} -eq 0 ]; then
        echo -e "${YELLOW}ê´€ë¦¬í•  ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.${NC}"
        break
    fi

    display_options=()
    for f in "${folders[@]}"; do
        log_file="$TMP_DIR/$f/logs.json"
        mtime=$(date -r "$TMP_DIR/$f" "+%Y-%m-%d %H:%M")

        # 2. ìš”ì•½ í…ìŠ¤íŠ¸ ì¶”ì¶œ (ì•ì„œ ê²€ì¦ëœ ë¡œì§)
        if [ -f "$log_file" ]; then
            context=$(grep -hPo '"message":\s*"\K[^"]+' "$log_file" | \
                      grep -vE "^/home/|^/|^[0-9a-f]{10,}|^/exit" | \
                      head -n 1)
            [ -z "$context" ] && context="(ëŒ€í™” ë‚´ìš© ì—†ìŒ)"
        else
            context="(ë¡œê·¸ íŒŒì¼ ì—†ìŒ)"
        fi

        # ìš”ì•½ë¬¸ ê°œí–‰ ì œê±° ë° ê¸¸ì´ ì œí•œ
        clean_ctx=$(echo "$context" | tr -d '\n' | sed 's/\\n/ /g' | sed 's/^ *//')
        display_options+=("[$mtime] ${clean_ctx:0:60}...")
    done

    # 3. ëŒ€í™”ì‹ ì„ íƒ ë©”ë‰´
    PS3=$'\nì‚­ì œí•  ë²ˆí˜¸ ì„ íƒ (ì¢…ë£Œ: q): '
    select opt in "${display_options[@]}"; do
        if [[ $REPLY == "q" ]]; then exit 0; fi
        if [ -n "$opt" ]; then
            idx=$((REPLY-1))
            real_hash="${folders[$idx]}"

            echo -e "\n${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
            echo -e "ğŸ•’ í™œë™ ì‹œê°„: ${GREEN}$(echo "$opt" | grep -oP '^\[.*?\]')${NC}"
            echo -e "ğŸ“ í•´ì‹œ í´ë”: ${YELLOW}$real_hash${NC}"
            echo -e "ğŸ’¬ ìš”ì•½ ë‚´ìš©: ${opt#*] }"
            echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"

            echo -en "${RED}ì´ Gemini ì„¸ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N)${NC} > "
            read -r confirm

            if [[ $confirm == [yY] ]]; then
                rm -rf "$TMP_DIR/$real_hash"
                echo -e "${GREEN}âœ… ì‚­ì œ ì™„ë£Œ!${NC}"
            fi
            break 
        else
            echo -e "${YELLOW}ì˜ëª»ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.${NC}"
            break
        fi
    done
done
