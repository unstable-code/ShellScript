#!/usr/bin/env bash

MIN=5
MID_LOW=5
MID_HIGH=45
MID_BRIGHT=40
MAX=50
FADE_STEP=1
FADE_DELAY=0.03

get_target_brightness() {
    lux=$1

    if [ "$lux" -le 0 ]; then echo $MIN; return; fi

    if [ "$lux" -lt "$MID_LOW" ]; then
        echo "$lux $MIN $MID_LOW $MID_BRIGHT" \
            | awk '{print int($1/$3*($4-$2)+$2)}'
        return
    fi

    if [ "$lux" -le "$MID_HIGH" ]; then
        echo $MID_BRIGHT
        return
    fi

    if [ "$lux" -lt 200 ]; then
        echo "$lux $MID_HIGH 200 $MID_BRIGHT $MAX" \
            | awk '{print int(($1-$2)/($3-$2)*($5-$4)+$4)}'
        return
    fi

    echo $MAX
}

fade_to() {
    target=$1
    current=$(brightnessctl -m | awk -F, '{gsub(/%/,"",$4); print $4}')
    [ -z "$current" ] && current=$target

    if [ "$current" -lt "$target" ]; then
        for ((b=current; b<=target; b+=FADE_STEP)); do
            brightnessctl set "${b}%"
            sleep "$FADE_DELAY"
        done
    else
        for ((b=current; b>=target; b-=FADE_STEP)); do
            brightnessctl set "${b}%"
            sleep "$FADE_DELAY"
        done
    fi
}

stdbuf -oL monitor-sensor 2>/dev/null | while read -r line; do
    if echo "$line" | grep -q "Light changed"; then
        lux=$(echo "$line" | sed -E 's/.*Light changed: ([0-9.]+).*/\1/')
        lux=${lux%.*}

        target=$(get_target_brightness "$lux")

        echo "lux: $lux â†’ target: ${target}%"

        fade_to "$target"
    fi
done

